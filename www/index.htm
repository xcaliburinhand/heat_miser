<!DOCTYPE html>
<html>
	<head>
		<title>Heat Miser</title>
		<link rel="stylesheet" href="style.css" />
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script type="text/javascript">
			google.charts.load('current', {
				'packages' : ['timeline']
			});

			function displayDate(direction) {
				if (document.getElementById('dateString').innerText === '') {
					var startDate = new Date( startDate = Date.now());
				} else {
					var startDate = new Date(document.getElementById('dateString').innerText);
				}
				if (direction == "+") {
					newDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 1);
				} else if (direction == "-") {
					newDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() - 1);
				} else {
					newDate = startDate;
				}
				document.getElementById('dateString').innerText = newDate.toDateString();
				google.charts.setOnLoadCallback(drawEquipChart);
				google.charts.setOnLoadCallback(drawHeatChart);
				updateCurrentState();
			}

			function updateCurrentState() {
				$.getJSON('data/current_state.json', function(data) {
					$.each(data, function(key, value) {
						if (value == 1) {
							var indicator = "background:red";
						} else {
							var indicatore = "";
						}
						$("#indicators").append("<div id=\"indicator_" + key + "\" style=\"text-align:center;width:50px;\"><p>" + key + "</p><div class=\"circle\" style=\"margin:0 auto;" + indicator + "\"></div></div>");
					});
				});
			}

			function drawEquipChart() {
				var beginDate = new Date(document.getElementById('dateString').innerText);
				var jsonData = $.ajax({
					url : "data/" + beginDate.getFullYear() + ('0' + parseInt(beginDate.getMonth() + 1).toString()).substring(0, 2) + beginDate.getDate() + ".json",
					dataType : "json",
					async : false
				}).responseText;
				try {
					var data = new google.visualization.DataTable(jsonData);
				} catch (err) {
					document.getElementById('equip_chart_div').innerHTML = '<b>No data available</b><br/>';
					return;
				}

				var options = {
					height : 275,
					hAxis : {
						minValue : new Date(beginDate.getFullYear(), beginDate.getMonth(), beginDate.getDate(), 0, 0),
						maxValue : new Date(beginDate.getFullYear(), beginDate.getMonth(), beginDate.getDate(), 23, 59)
					},
					timeline : {
						groupByRowLabel : true
					}
				};

				var chart = new google.visualization.Timeline(document.getElementById('equip_chart_div'));

				chart.draw(data, options);
			}

			function drawHeatChart() {
				var beginDate = new Date(document.getElementById('dateString').innerText);
				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Zone');
				data.addColumn('date', 'Equipment On');
				data.addColumn('date', 'Equipment Off');

				data.addRows([['Heat Call', new Date(2017, 1, 5, 2, 45), new Date(2017, 1, 5, 4, 0)], ['Burner', new Date(2017, 1, 5, 3, 33), new Date(2017, 1, 5, 3, 55)]]);

				var options = {
					height : 175,
					hAxis : {
						minValue : new Date(2017, 1, 5, 0, 0),
						maxValue : new Date(2017, 1, 5, 23, 59)
					},
					timeline : {
						groupByRowLabel : true
					}
				};

				var chart = new google.visualization.Timeline(document.getElementById('heat_chart_div'));

				chart.draw(data, options);
			}
		</script>
	</head>
	<body>
		<div id="indicators">

		</div>
		<br>
		<br>
		<div id="equip_chart_div"></div>
		<div id="heat_chart_div"></div>
		<div id="date_selector">
			<a onclick='displayDate("-");' style="cursor: pointer">&lt;</a>&nbsp;<span id="dateString">
				<script>
					displayDate();
				</script></span>&nbsp;<a onclick='displayDate("+");' style="cursor: pointer">&gt;</a>
		</div>
	</body>
</html>
